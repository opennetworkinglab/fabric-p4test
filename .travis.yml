dist: trusty

language: python

services:
  - docker

python:
  - "2.7"

env:
  global:
    - ONOS_BRANCH=onos-2.2
    - PROFILES=all
    - FP4TEST_DOCKER_IMG=fp4test
    - ONOS_ROOT=/tmp/onos

install:
  - docker build -t fp4test .

jobs:
  include:
    - stage: ptf
      name: "Run PTF tests on stratum_bmv2"
      script:
        - git clone --depth 1 https://github.com/opennetworkinglab/onos /tmp/onos -b $ONOS_BRANCH
        - ./run/bmv2/run $PROFILES
    - stage: checkstyle
      name: "Checkstyle"
      install: skip
      script:
        - pip install pycodestyle
        - find . -name \*.py -exec pycodestyle --max-line-length=120 --ignore=E126,E127,E722,E502,E131 {} +
    - stage: push
      name: "Docker push"
      script:
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker tag fp4test $DOCKER_REPO
        - docker push $DOCKER_REPO

stages:
  - ptf
  - checkstyle
  - name: push
    if: type != pull_request AND branch = master
